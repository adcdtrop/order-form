<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product Order Form</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
      padding: 10px;
      max-width: 1200px;
      margin: auto;
      overflow-x: hidden;
    }
    
    h2 {
      text-align: center;
      color: #007BFF;
      margin-bottom: 30px;
      font-size: 1.5rem;
    }
    
    .form-row {
      background: #f9f9f9;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      padding: 15px;
    }
    
    .product-header {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 15px;
      align-items: end;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .form-group label {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
      text-transform: uppercase;
      color: #555;
    }
    
    .form-group select,
    .form-group input {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      min-width: 0;
      height: 40px;
    }
    
    .form-group input[readonly] {
      background: #eef5ff;
      color: #007BFF;
      font-weight: bold;
      text-align: center;
    }
    
    .flavors-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #e0e0e0;
    }
    
    .flavors-title {
      font-size: 14px;
      font-weight: bold;
      color: #007BFF;
      margin-bottom: 15px;
      text-transform: uppercase;
    }
    
    .flavor-row {
      display: grid;
      grid-template-columns: 1fr auto auto; /* select, quantity-control, remove-btn */
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: #fff;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }
    
    .flavor-select {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      height: 36px;
    }
    
    .quantity-input {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      height: 36px;
      text-align: center;
    }

    .quantity-control {
      display: flex;
      align-items: center;
    }

    .quantity-btn {
      background-color: #e9ecef;
      color: #495057;
      border: 1px solid #ccc;
      padding: 0;
      width: 30px;
      height: 36px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      line-height: 34px; 
    }
    .quantity-btn:hover {
      background-color: #ced4da;
    }
    .quantity-btn:active {
      background-color: #adb5bd;
    }

    .quantity-btn.quantity-minus {
      border-right: none;
      border-radius: 4px 0 0 4px;
    }

    .quantity-btn.quantity-plus {
      border-left: none;
      border-radius: 0 4px 4px 0;
    }

    .flavor-row .quantity-control .quantity-input {
      width: 50px; 
      border-radius: 0; 
      border-left: 1px solid #ccc; 
      border-right: 1px solid #ccc;
      padding: 8px 4px; 
    }
    
    .remove-flavor-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      padding: 8px 12px;
      cursor: pointer;
      height: 36px;
      min-width: 60px;
    }
    
    .remove-flavor-btn:hover {
      background-color: #c82333;
    }
    
    .add-flavor-btn {
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      padding: 8px 15px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .add-flavor-btn:hover {
      background-color: #218838;
    }
    
    .add-flavor-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    .product-total {
      text-align: right;
      font-size: 16px;
      font-weight: bold;
      color: #007BFF;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
    }
    
    .delete-btn {
      background-color: #ffa500;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      padding: 8px;
      cursor: pointer;
      width: 100%;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .delete-btn:hover {
      background-color: #ff8c00;
    }
    
    .btn,
    .submit-btn {
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      width: 100%;
      max-width: 200px;
    }
    
    .btn {
      background-color: #007BFF;
      color: white;
      margin-bottom: 20px;
    }
    
    .btn:hover {
      background-color: #0056b3;
    }
    
    .submit-btn {
      background-color: #ffa500;
      color: white;
      width: 100%;
      max-width: none;
      margin-top: 20px;
    }
    
    .submit-btn:hover {
      background-color: #e69500;
    }
    
    .total-box {
      font-size: 18px;
      text-align: center;
      margin-top: 20px;
      background: #eef5ff;
      padding: 15px;
      border: 2px solid #007BFF;
      color: #007BFF;
      border-radius: 8px;
      word-break: break-word;
    }

    .total-box div {
        margin-bottom: 5px; 
    }
    .total-box div:last-child {
        margin-bottom: 0;
    }
    
    .customer-name {
      margin-bottom: 20px;
      position: relative;
      width: 100%;
    }
    
    .loading-overlay {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007BFF;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #007BFF;
      font-size: 18px;
      font-weight: bold;
    }
    
    .search-container {
      position: relative;
      width: 100%;
    }
    
    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #ddd;
      border-top: none;
      border-radius: 0 0 5px 5px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .dropdown-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      word-break: break-word;
    }
    
    .dropdown-item:hover,
    .dropdown-item.active {
      background-color: #f0f0f0;
    }
    
    .dropdown-item:last-child {
      border-bottom: none;
    }
    
    .no-results {
      padding: 10px 12px;
      color: #666;
      font-style: italic;
    }
    
    .customer-status {
      font-size: 12px;
      margin-top: 5px;
      color: #666;
    }
     .customer-address-display {
      font-size: 14px;
      color: #333;
      background-color: #f0f8ff;
      border: 1px solid #b0c4de;
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 8px;
      word-break: break-word;
    }
    
    .customer-warning {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-top: 5px;
      font-size: 14px;
      display: none;
      word-break: break-word;
    }
    .order-date {
      margin-bottom: 20px;
      position: relative;
      width: 100%;
    }

    .order-date input[type="date"] {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      min-width: 0;
      height: 40px;
    }

    .order-date input[type="date"]:focus {
      border-color: #007BFF;
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .order-date label {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
      text-transform: uppercase;
      color: #555;
      display: block;
    }
    
    @media (max-width: 1024px) {
      body {
        padding: 8px;
      }
      
      .product-header {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      
      .delete-btn {
        grid-column: span 2;
        margin-top: 10px;
        max-width: 150px;
        justify-self: center;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      
      h2 {
        font-size: 1.3rem;
        margin-bottom: 20px;
      }
      
      .form-row {
        padding: 12px;
      }
      
      .product-header {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .flavor-row {
        grid-template-columns: 1fr; 
        gap: 10px;
        text-align: center;
      }
      
      .flavor-row .quantity-control {
        justify-content: center; 
        margin: 0 auto; 
        max-width: 180px; 
        width: 100%; 
      }
      .flavor-row .quantity-control .quantity-input {
        flex-grow: 1; 
        min-width: 40px; 
        max-width: 80px; 
        width: auto; 
      }
       .flavor-row .quantity-control .quantity-btn {
        flex-shrink: 0; 
      }
      
      .remove-flavor-btn {
        width: 100%;
        max-width: 120px;
        margin: 0 auto;
      }
      
      .form-group label {
        font-size: 13px;
        margin-bottom: 6px;
      }
      
      .form-group select,
      .form-group input {
        padding: 12px 8px;
        font-size: 16px;
        min-height: 44px;
        height: 44px;
      }
      
      .delete-btn {
        padding: 12px;
        font-size: 16px;
        min-height: 44px;
        height: 44px;
        margin-top: 10px;
        max-width: none;
        width: 100%;
      }
      
      .btn {
        max-width: none;
        padding: 15px 20px;
        font-size: 18px;
      }
      
      .submit-btn {
        padding: 15px 20px;
        font-size: 18px;
        margin-top: 30px;
      }
      
      .total-box {
        font-size: 20px;
        padding: 20px 15px;
        margin-top: 30px;
      }
      
      .dropdown-list {
        max-height: 150px;
      }
      
      .dropdown-item {
        padding: 15px 12px;
        font-size: 16px;
      }
      
      .customer-warning {
        font-size: 15px;
        padding: 12px;
      }
       .customer-address-display {
        font-size: 15px;
        padding: 12px;
      }
    }
    .order-date {
      margin-bottom: 15px;
    }

    .order-date input[type="date"] {
      padding: 12px 8px;
      font-size: 16px;
      min-height: 44px;
      height: 44px;
    }

    .order-date label {
      font-size: 13px;
      margin-bottom: 6px;
    }
    
    @media (max-width: 480px) {
      body {
        padding: 3px;
      }
      
      h2 {
        font-size: 1.2rem;
      }
      
      .form-row {
        padding: 10px 8px;
      }
      
      .total-box {
        font-size: 18px;
        padding: 15px 10px;
      }
      
      .flavor-row {
        padding: 8px;
      }
      .flavor-row .quantity-control {
        max-width: 160px; 
      }
      .customer-address-display {
        font-size: 14px;
        padding: 10px;
      }
    }
    
    @media (min-width: 1200px) {
      .form-row {
        max-width: 1000px;
        margin-left: auto;
        margin-right: auto;
      }
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading customers...</div>
  </div>

  <h2>Product Order Form</h2>
  <form id="orderForm" onsubmit="submitOrder(event)">
    <div class="form-group customer-name">
      <label for="customerName">Customer Name</label>
      <div class="search-container">
        <input type="text" id="customerName" name="customerName" placeholder="Search for customer..." required autocomplete="off" />
        <div id="customerDropdownList" class="dropdown-list"></div>
      </div>
      <div id="selectedCustomerAddress" class="customer-address-display" style="display: none;"></div>
      <div id="customerStatus" class="customer-status">Loading customers...</div>
      <div id="customerWarning" class="customer-warning">
        ⚠️ Customer not found in the system. Select from Dropdown
      </div>
    </div>
    <div class="form-group order-date">
      <label for="orderDate">Delivery Date</label>
      <input type="date" id="orderDate" name="orderDate" required />
      <div id="orderDateStatus" class="customer-status" style="display: none;"></div>
    </div>
    <div id="order-form"></div>
    <button class="btn" type="button" onclick="addProductRow()">+ Add Product</button>
    <div class="total-box">
      <div>Grand Total: $<span id="grandTotal">0.00</span></div>
      <div>Total Quantity: <span id="grandQuantity">0</span> units</div>
    </div>
    <div id="validationErrors" class="validation-errors" style="display: none;"></div>
    <button class="submit-btn" type="submit">Submit Order</button>
  </form>

  <script>
    const WEBHOOK_URL = "https://hook.us2.make.com/675ao9xc3l8a0fwiqlb9iyq7xrh3r81j"; // Your webhook URL
    
    // Monday.com API Configuration
    const MONDAY_API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjUxOTIxNzk3MCwiYWFpIjoxMSwidWlkIjo3NjYxMTgyNiwiaWFkIjoiMjAyNS0wNS0yOVQwMTozNDoxOS4wMDBaIiwicGVyIjoibWU6d3JpdGUiLCJhY3RpZCI6Mjk0NjY1NjMsInJnbiI6InVzZTEifQ.YusQcMMhB4qL_QYTIhVVOzaaoN5i2ReecYQSDvNSoLU';
    
    // Customer Board Configuration
    const CUSTOMER_BOARD_ID = '9197029495'; // Your customer board ID
    const ADDRESS_COLUMN_ID = 'text_mkr4mkaa'; // Customer address column ID

    // Product Board Configuration (as per your provided function)
    const PRODUCT_BOARD_ID = 9287107016;
    const PRICE_COLUMN_ID = 'numeric_mkrjw3zn';
    const SIZE_NAME_COLUMN_ID = 'text_mkrk5wbk'; // This holds the "size description" string e.g. "10 oz. 24pk"
    const FLAVOURS_COLUMN_ID = 'text_mkrkqys4'; // Comma-separated text for flavors
    const PRODUCT_GROUP_ID = "topics"; // Group ID where products are located, adjust if different

    let allCustomers = [];
    let filteredCustomers = [];
    let selectedCustomerId = null;
    let selectedCustomerAddress = '';

    let data = {}; // Product data will be populated here dynamically

    let rowCount = 0;
    let activeRows = new Set();
    let flavorCount = {};

    // --- Product Data Fetching and Initialization ---
    async function fetchAllMondayProducts() {
      let allItems = [];
      let cursor = null;
      const itemsPerPage = 100;
      let pageCount = 0;

      try {
        do {
          pageCount++;
          const query = `{
            boards(ids: ${PRODUCT_BOARD_ID}) {
              groups(ids: ["${PRODUCT_GROUP_ID}"]) {
                items_page(limit: ${itemsPerPage}${cursor ? `, cursor: "${cursor}"` : ''}) {
                  cursor
                  items {
                    name # This will be used as Category
                    column_values(ids: ["${PRICE_COLUMN_ID}", "${SIZE_NAME_COLUMN_ID}", "${FLAVOURS_COLUMN_ID}"]) {
                      id
                      text
                      value # For numeric, value might be more reliable if text is formatted
                    }
                  }
                }
              }
            }
          }`;

          const response = await fetch('https://api.monday.com/v2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': MONDAY_API_KEY },
            body: JSON.stringify({ query })
          });

          if (!response.ok) throw new Error(`HTTP ${response.status} ${response.statusText} while fetching products`);
          
          const responseData = await response.json();
          if (responseData.errors) throw new Error(`GraphQL Error fetching products: ${JSON.stringify(responseData.errors)}`);
          if (!responseData.data || !responseData.data.boards || responseData.data.boards.length === 0) {
            throw new Error('No product boards found or board data is empty.');
          }

          const board = responseData.data.boards[0];
          if (!board.groups || board.groups.length === 0) {
            console.warn(`Group "${PRODUCT_GROUP_ID}" not found or product board has no groups.`);
            break; 
          }

          const targetGroup = board.groups[0]; // Assuming the first group returned by the ID filter is the one
          if (!targetGroup || !targetGroup.items_page) {
            console.warn(`Group "${PRODUCT_GROUP_ID}" found, but no items_page in it. Or group filter failed.`);
            cursor = null; // Stop pagination if no items_page
            break;
          }
          
          const itemsPage = targetGroup.items_page;
          if (itemsPage && itemsPage.items && itemsPage.items.length > 0) {
            allItems = allItems.concat(itemsPage.items);
            cursor = itemsPage.cursor;
          } else {
            cursor = null; // No more items or no items on this page
          }
          if (pageCount > 50) { // Safety break for pagination
             console.warn("Product fetch pagination limit reached.");
             break;
          }
        } while (cursor);

        const transformedData = {};
        allItems.forEach(item => {
          const category = item.name; // Item name is the Category

          const getValue = (id, useValueForNumeric = false) => {
            const col = item.column_values.find(c => c.id === id);
            if (!col) return null;
            if (useValueForNumeric && col.value) {
                try {
                    const parsedValue = JSON.parse(col.value);
                    // Check if it's a simple number or a string that can be parsed to a number
                    if (typeof parsedValue === 'number') return parsedValue;
                    if (typeof parsedValue === 'string' && !isNaN(parseFloat(parsedValue))) return parseFloat(parsedValue);
                } catch (e) { /* ignore parsing error, fall back to text */ }
            }
            return col.text ? col.text.trim() : null;
          };
          
          const sizeName = getValue(SIZE_NAME_COLUMN_ID); // e.g., "10 oz. 24pk"
          const priceRaw = getValue(PRICE_COLUMN_ID, true); // Try to get numeric value first
          const price = (priceRaw !== null && !isNaN(parseFloat(priceRaw))) ? parseFloat(priceRaw) : null;
          
          const flavoursRaw = getValue(FLAVOURS_COLUMN_ID);
          const flavours = (flavoursRaw && flavoursRaw.toLowerCase() !== 'none') 
            ? flavoursRaw.split(',').map(f => f.trim()).filter(f => f) // filter out empty strings if any
            : [];

          if (!category || !sizeName || price === null) {
            console.warn("Skipping product item due to missing critical data:", { category, sizeName, price, item });
            return;
          }

          if (!transformedData[category]) transformedData[category] = {};
          transformedData[category][sizeName] = { price, flavors: flavours };
        });
        
        console.log("Transformed Product Data:", JSON.stringify(transformedData, null, 2));
        return transformedData;

      } catch (error) {
        console.error('Error fetching or transforming Monday.com products:', error);
        return {}; // Return empty object on error
      }
    }

    async function initializeProductData() {
        showLoadingOverlay('Loading products...');
        try {
            const fetchedProducts = await fetchAllMondayProducts();
            if (Object.keys(fetchedProducts).length > 0) {
                data = fetchedProducts; // Assign to the global 'data' variable
                // updateCustomerStatus might be confusing here if it's tied to customer loading,
                // so just log or use a separate status for products if needed.
                console.log("Products loaded successfully from Monday.com.");
            } else {
                console.error("No products fetched from Monday.com or data is empty. Product selection might not work.");
                updateCustomerStatus('Failed to load products. Product selection may be unavailable.', 'error');
            }
        } catch (error) {
            console.error('Error initializing product data:', error);
            updateCustomerStatus(`Error loading products: ${error.message}. Product selection may be unavailable.`, 'error');
        }
    }


    // --- Customer Data and Form Logic (mostly existing) ---
    function setDefaultOrderDate() {
      const orderDateInput = document.getElementById('orderDate');
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1); 
      const formattedDate = tomorrow.toISOString().split('T')[0];
      orderDateInput.value = formattedDate;
    }

    function validateOrderDate() {
      const orderDateInput = document.getElementById('orderDate');
      const orderDateStatus = document.getElementById('orderDateStatus');
      if (!orderDateInput.value) {
        orderDateStatus.textContent = 'Order date is required';
        orderDateStatus.style.color = '#c62828';
        orderDateStatus.style.display = 'block';
        return false;
      }
      orderDateStatus.style.display = 'none';
      return true;
    }

    function showValidationErrors(errors) {
      const errorDiv = document.getElementById('validationErrors');
      if (errors.length > 0) {
        errorDiv.innerHTML = `
          <div style="background-color: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 15px; margin: 15px 0; color: #c62828;">
            <strong>⚠️ Please fix the following issues before submitting:</strong>
            <ul style="margin: 10px 0 0 20px;">
              ${errors.map(error => `<li>${error}</li>`).join('')}
            </ul>
          </div>
        `;
        errorDiv.style.display = 'block';
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
      } else {
        errorDiv.style.display = 'none';
        return true;
      }
    }

    function validateForm() {
      const errors = [];
      const customerName = document.getElementById('customerName').value.trim();
      if (!customerName) errors.push('Customer name is required');
      else if (!isValidCustomer(customerName)) errors.push('Please select a valid customer from the dropdown list');
      
      if (!document.getElementById('orderDate').value) errors.push('Order date is required');
      
      if (activeRows.size === 0) {
        errors.push('At least one product must be added');
      }
      
      if (Object.keys(data).length === 0) {
          errors.push('Product data is not loaded. Cannot validate products.');
      }


      let hasValidProducts = false;
      let productIndex = 1;
      
      activeRows.forEach(rowId => {
        const categorySelect = document.querySelector(`#${rowId} select`);
        const category = categorySelect ? categorySelect.value : null;
        const sizeSelect = document.getElementById(`${rowId}-size`);
        const size = sizeSelect ? sizeSelect.value : null;
        
        if (!category) errors.push(`Product ${productIndex}: Category must be selected`);
        if (!size) errors.push(`Product ${productIndex}: Size must be selected`);
        
        // Check if data[category] and data[category][size] exist before accessing properties
        if (category && size && data[category] && data[category][size]) {
          const flavorRows = document.querySelectorAll(`#${rowId}-flavors-list .flavor-row`);
          let hasValidFlavors = false;
          if (flavorRows.length === 0) {
            errors.push(`Product ${productIndex}: At least one flavor must be added`);
          } else {
            let flavorIndex = 1;
            flavorRows.forEach(row => {
              const flavor = row.querySelector('.flavor-select').value;
              const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
              if (!flavor) errors.push(`Product ${productIndex}, Flavor ${flavorIndex}: Flavor must be selected`);
              if (quantity <= 0) errors.push(`Product ${productIndex}, Flavor ${flavorIndex}: Quantity must be greater than 0`);
              if (flavor && quantity > 0) {
                hasValidFlavors = true;
                hasValidProducts = true;
              }
              flavorIndex++;
            });
            if (!hasValidFlavors && flavorRows.length > 0) errors.push(`Product ${productIndex}: At least one flavor with valid quantity is required`);
          }
        } else if (category && size) { // Category and size selected but not found in dynamic data
            errors.push(`Product ${productIndex}: Selected category '${category}' or size '${size}' is not available.`);
        }
        productIndex++;
      });
      
      if (!hasValidProducts && errors.length === 0 && activeRows.size > 0) {
        errors.push('At least one complete product (with category, size, flavor, and quantity) is required');
      }
      
      if (parseFloat(document.getElementById('grandTotal').textContent) <= 0 && hasValidProducts && activeRows.size > 0) {
         errors.push('Order total must be greater than $0.00');
      } else if (parseFloat(document.getElementById('grandTotal').textContent) <= 0 && activeRows.size > 0 && !hasValidProducts && errors.length === 0) {
         errors.push('Order total must be greater than $0.00, ensure products have valid quantities.');
      }
      return showValidationErrors(errors);
    }

    function highlightIncompleteFields() {
      document.querySelectorAll('input, select').forEach(field => field.style.borderColor = '#ddd');
      const customerNameInput = document.getElementById('customerName');
      if (!customerNameInput.value.trim() || !isValidCustomer(customerNameInput.value.trim())) customerNameInput.style.borderColor = '#f44336';
      if (!document.getElementById('orderDate').value) document.getElementById('orderDate').style.borderColor = '#f44336';
      activeRows.forEach(rowId => {
        const categorySelect = document.querySelector(`#${rowId} select`);
        const sizeSelect = document.getElementById(`${rowId}-size`);
        if (categorySelect && !categorySelect.value) categorySelect.style.borderColor = '#f44336';
        if (sizeSelect && !sizeSelect.value) sizeSelect.style.borderColor = '#f44336';
        document.querySelectorAll(`#${rowId}-flavors-list .flavor-row`).forEach(row => {
          const flavorSelect = row.querySelector('.flavor-select');
          const quantityInput = row.querySelector('.quantity-input');
          if (!flavorSelect.value) flavorSelect.style.borderColor = '#f44336';
          if (!quantityInput.value || parseInt(quantityInput.value) <= 0) quantityInput.style.borderColor = '#f44336';
        });
      });
    }

    function updateCustomerStatus(message, type = 'loading') {
      const statusEl = document.getElementById('customerStatus');
      statusEl.textContent = message;
      statusEl.style.color = type === 'error' ? '#c62828' : type === 'success' ? '#2e7d32' : '#666';
    }

    function showCustomerWarning(show = true) {
      document.getElementById('customerWarning').style.display = show ? 'block' : 'none';
      if (show) {
        document.getElementById('selectedCustomerAddress').style.display = 'none';
        document.getElementById('selectedCustomerAddress').textContent = '';
      }
    }
    
    function displaySelectedCustomerAddress(address) {
        const addressDisplayEl = document.getElementById('selectedCustomerAddress');
        if (address && address.trim() !== '') {
            addressDisplayEl.textContent = `Address: ${address}`;
            addressDisplayEl.style.display = 'block';
        } else {
            addressDisplayEl.textContent = 'Address: Not available';
            addressDisplayEl.style.display = 'block'; 
        }
    }

    function isValidCustomer(customerName) {
      return allCustomers.some(customer => customer.name === customerName);
    }

    function getCustomerByName(customerName) { 
        return allCustomers.find(customer => customer.name === customerName);
    }


    function hideLoadingOverlay() { document.getElementById('loadingOverlay').style.display = 'none'; }
    function showLoadingOverlay(text = 'Loading...') {
      const overlay = document.getElementById('loadingOverlay');
      overlay.querySelector('.loading-text').textContent = text;
      overlay.style.display = 'flex';
    }

    async function fetchAllMondayCustomers() {
      updateCustomerStatus('Loading customers...', 'loading');
      try {
        if (!MONDAY_API_KEY || !CUSTOMER_BOARD_ID) throw new Error('API Key or Customer Board ID is missing');
        let allItems = []; let cursor = null; let pageCount = 0; const itemsPerPage = 100;
        do {
          pageCount++;
          const query = `{ 
            boards(ids: ${CUSTOMER_BOARD_ID}) { 
              items_page(limit: ${itemsPerPage}${cursor ? `, cursor: "${cursor}"` : ''}) { 
                cursor 
                items { 
                  id 
                  name 
                  column_values(ids: ["${ADDRESS_COLUMN_ID}"]) {
                    id
                    text
                  }
                } 
              } 
            } 
          }`;
          const response = await fetch('https://api.monday.com/v2', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': MONDAY_API_KEY }, body: JSON.stringify({ query }) });
          if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText} while fetching customers`);
          const responseData = await response.json();
          if (responseData.errors) throw new Error(`GraphQL Error fetching customers: ${JSON.stringify(responseData.errors)}`);
          if (!responseData.data || !responseData.data.boards || responseData.data.boards.length === 0) throw new Error('No customer boards found');
          
          const itemsPage = responseData.data.boards[0].items_page;
          if (itemsPage && itemsPage.items) {
            const newItems = itemsPage.items.map(item => {
              let address = '';
              if (item.column_values && item.column_values.length > 0) {
                const addressColumn = item.column_values.find(cv => cv.id === ADDRESS_COLUMN_ID);
                if (addressColumn && addressColumn.text) {
                  address = addressColumn.text;
                }
              }
              return { id: item.id, name: item.name, address: address };
            });
            allItems = allItems.concat(newItems);
            cursor = itemsPage.cursor;
          } else break;
          if (pageCount > 100) { console.warn('Max page limit reached for customers'); break; }
        } while (cursor);
        return allItems;
      } catch (error) { console.error('Error fetching Monday.com customers:', error); updateCustomerStatus(`Error: ${error.message}`, 'error'); return []; }
    }

    function filterCustomers(searchTerm) {
      if (!searchTerm) { filteredCustomers = []; return; }
      const term = searchTerm.toLowerCase();
      filteredCustomers = allCustomers.filter(customer => customer.name.toLowerCase().includes(term)).slice(0, 50);
    }

    function displayCustomerDropdown() {
      const dropdown = document.getElementById('customerDropdownList');
      const input = document.getElementById('customerName');
      if (filteredCustomers.length === 0 && input.value) { dropdown.innerHTML = '<div class="no-results">No customers found</div>'; dropdown.style.display = 'block'; return; }
      if (filteredCustomers.length === 0) { dropdown.style.display = 'none'; return; }
      dropdown.innerHTML = filteredCustomers.map(customer => `<div class="dropdown-item" data-value="${customer.name}" data-id="${customer.id}" data-address="${customer.address || ''}">${customer.name}</div>`).join('');
      dropdown.style.display = 'block';
    }

    function hideCustomerDropdown() { setTimeout(() => { document.getElementById('customerDropdownList').style.display = 'none'; }, 150); }

    async function initializeCustomerDropdown() {
      showLoadingOverlay('Loading customers...'); // Keep this specific to customers
      try {
        allCustomers = await fetchAllMondayCustomers();
        if (allCustomers.length === 0) { updateCustomerStatus('No customers found', 'error'); }
        else { updateCustomerStatus(`${allCustomers.length} customers loaded`, 'success');}
      } catch (error) { 
        console.error('Error initializing customer dropdown:', error); 
        updateCustomerStatus(`Error: ${error.message}`, 'error'); 
      }
      // Loading overlay will be hidden after all initial data is fetched in DOMContentLoaded
    }

    function addProductRow() {
      rowCount++; const rowId = `row-${rowCount}`; activeRows.add(rowId); flavorCount[rowId] = 1;
      const row = document.createElement('div'); row.className = 'form-row'; row.id = rowId;
      
      // Create category options from dynamically loaded 'data'
      let categoryOptions = '<option value="">Select Category</option>';
      if (Object.keys(data).length > 0) {
          categoryOptions += Object.keys(data).map(cat => `<option value="${cat}">${cat}</option>`).join('');
      } else {
          console.warn("No product data available to populate categories.");
      }

      row.innerHTML = `
        <div class="product-header">
          <div class="form-group"><label>Category</label><select onchange="populateSizes('${rowId}', this.value); clearValidationErrors();">${categoryOptions}</select></div>
          <div class="form-group"><label>Size</label><select id="${rowId}-size" onchange="populateFlavors('${rowId}', this.value); clearValidationErrors();"><option value="">Select Size</option></select></div>
          <div class="form-group"><label> </label><button class="delete-btn" type="button" onclick="deleteRow('${rowId}')">×</button></div>
        </div>
        <div class="flavors-section" id="${rowId}-flavors-section" style="display: none;">
          <div class="flavors-title">Select Flavors and Quantities</div><div id="${rowId}-flavors-list"></div>
          <button type="button" class="add-flavor-btn" id="${rowId}-add-flavor" onclick="addFlavorRow('${rowId}')" disabled>+ Add More</button>
        </div>
        <div class="product-total" id="${rowId}-total">Product Total: $0.00</div>`;
      document.getElementById('order-form').appendChild(row);
      updateDeleteButtons(); updateTotal();
    }

    function clearValidationErrors() {
      document.getElementById('validationErrors').style.display = 'none';
      document.querySelectorAll('input, select').forEach(field => { if (field.style.borderColor === 'rgb(244, 67, 54)') field.style.borderColor = '#ddd'; });
      document.getElementById('orderDateStatus').style.display = 'none';
    }

    function populateSizes(rowId, category) {
      const sizeField = document.getElementById(`${rowId}-size`);
      const flavorsSection = document.getElementById(`${rowId}-flavors-section`);
      sizeField.innerHTML = '<option value="">Select Size</option>'; flavorsSection.style.display = 'none';
      // Ensure data and data[category] exist before trying to get keys
      if (category && data && data[category]) { 
        Object.keys(data[category]).forEach(size => { sizeField.innerHTML += `<option value="${size}">${size}</option>`; }); 
      }
      updateTotal();
    }

    function populateFlavors(rowId, size) {
      const categorySelect = document.querySelector(`#${rowId} select`);
      const category = categorySelect ? categorySelect.value : null;
      const flavorsSection = document.getElementById(`${rowId}-flavors-section`);
      const flavorsList = document.getElementById(`${rowId}-flavors-list`);
      const addButton = document.getElementById(`${rowId}-add-flavor`);
      
      // Ensure data, data[category], and data[category][size] exist
      if (category && size && data && data[category] && data[category][size]) {
        flavorsSection.style.display = 'block'; flavorsList.innerHTML = ''; flavorCount[rowId] = 1;
        addFlavorRowInternal(rowId); addButton.disabled = false;
      } else { 
        flavorsSection.style.display = 'none'; 
        if(addButton) addButton.disabled = true; 
      }
      updateTotal();
    }

    function addFlavorRow(rowId) { flavorCount[rowId]++; addFlavorRowInternal(rowId); }

    function addFlavorRowInternal(rowId) {
      const categorySelect = document.querySelector(`#${rowId} select`);
      const category = categorySelect ? categorySelect.value : null;
      const sizeSelect = document.getElementById(`${rowId}-size`);
      const size = sizeSelect ? sizeSelect.value : null;

      const flavorsList = document.getElementById(`${rowId}-flavors-list`);
      const flavorElementId = `${rowId}-flavor-${flavorCount[rowId]}`; 
      
      // Ensure all necessary data parts exist
      if (!category || !size || !data || !data[category] || !data[category][size] || !data[category][size].flavors) {
          console.warn("Cannot add flavor row: missing data for category/size or flavors array.", {category, size, dataExists: !!data});
          return;
      }
      const availableFlavors = data[category][size].flavors;
      if (!Array.isArray(availableFlavors)) {
          console.warn("Cannot add flavor row: availableFlavors is not an array.", {category, size, availableFlavors});
          return;
      }

      const flavorRow = document.createElement('div'); flavorRow.className = 'flavor-row'; flavorRow.id = flavorElementId;
      flavorRow.innerHTML = `
        <select class="flavor-select" onchange="updateTotal(); clearValidationErrors();"><option value="">Select Flavor</option>${availableFlavors.map(f => `<option value="${f}">${f}</option>`).join('')}</select>
        <div class="quantity-control">
            <button type="button" class="quantity-btn quantity-minus" onclick="decrementQuantity('${flavorElementId}')">-</button>
            <input type="number" class="quantity-input" min="1" value="1" onchange="updateTotal(); clearValidationErrors();" placeholder="Qty" />
            <button type="button" class="quantity-btn quantity-plus" onclick="incrementQuantity('${flavorElementId}')">+</button>
        </div>
        <button type="button" class="remove-flavor-btn" onclick="removeFlavorRow('${flavorElementId}', '${rowId}')">Remove</button>`;
      flavorsList.appendChild(flavorRow); updateRemoveFlavorButtons(rowId);
    }

    function incrementQuantity(flavorRowId) {
        const flavorRowElement = document.getElementById(flavorRowId);
        if (!flavorRowElement) return;
        const quantityInput = flavorRowElement.querySelector('.quantity-input');
        if (quantityInput) {
            let currentValue = parseInt(quantityInput.value) || 0;
            quantityInput.value = currentValue + 1;
            updateTotal();
            clearValidationErrors();
        }
    }

    function decrementQuantity(flavorRowId) {
        const flavorRowElement = document.getElementById(flavorRowId);
        if (!flavorRowElement) return;
        const quantityInput = flavorRowElement.querySelector('.quantity-input');
        if (quantityInput) {
            let currentValue = parseInt(quantityInput.value) || 1;
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
            } else {
                quantityInput.value = 1; 
            }
            updateTotal();
            clearValidationErrors();
        }
    }

    function removeFlavorRow(flavorId, rowId) {
      const flavorRow = document.getElementById(flavorId);
      if (flavorRow) { flavorRow.remove(); updateRemoveFlavorButtons(rowId); updateTotal(); }
    }

    function updateRemoveFlavorButtons(rowId) {
      const flavorRows = document.querySelectorAll(`#${rowId}-flavors-list .flavor-row`);
      flavorRows.forEach(row => { row.querySelector('.remove-flavor-btn').style.display = flavorRows.length > 1 ? 'block' : 'none'; });
    }

    function updateDeleteButtons() {
      document.querySelectorAll('.delete-btn').forEach(btn => { btn.style.display = activeRows.size > 1 ? 'flex' : 'none'; });
    }

    function deleteRow(rowId) {
      if (activeRows.size > 1) {
        document.getElementById(rowId).remove(); activeRows.delete(rowId); delete flavorCount[rowId];
        updateDeleteButtons(); updateTotal(); clearValidationErrors();
      }
    }

    function updateTotal() {
      let grandTotal = 0; let grandQuantity = 0;
      activeRows.forEach(rowId => {
        const categorySelect = document.querySelector(`#${rowId} select`);
        const category = categorySelect ? categorySelect.value : null;
        const sizeSelect = document.getElementById(`${rowId}-size`);
        const size = sizeSelect ? sizeSelect.value : null;
        
        let productTotal = 0;
        // Ensure data, data[category], and data[category][size] exist before calculating
        if (category && size && data && data[category] && data[category][size]) {
          const unitPrice = data[category][size].price;
          const flavorRows = document.querySelectorAll(`#${rowId}-flavors-list .flavor-row`);
          flavorRows.forEach(row => {
            const flavor = row.querySelector('.flavor-select').value;
            const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
            if (flavor && quantity > 0) { productTotal += quantity * unitPrice; grandQuantity += quantity; }
          });
        }
        const productTotalEl = document.getElementById(`${rowId}-total`);
        if (productTotalEl) productTotalEl.textContent = `Product Total: $${productTotal.toFixed(2)}`;
        grandTotal += productTotal;
      });
      document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
      document.getElementById('grandQuantity').textContent = grandQuantity;
    }

    async function submitOrder(event) {
      event.preventDefault();
      clearValidationErrors();
      if (!validateForm()) { highlightIncompleteFields(); return; }
      
      const customerName = document.getElementById('customerName').value.trim();
      const customerDetails = getCustomerByName(customerName); 

      const orderData = {
        customer: { 
            name: customerName, 
            id: customerDetails ? customerDetails.id : null,
            address: customerDetails ? customerDetails.address : '' 
        },
        orderDate: document.getElementById('orderDate').value,
        products: [],
        grandTotal: parseFloat(document.getElementById('grandTotal').textContent),
        grandQuantity: parseInt(document.getElementById('grandQuantity').textContent) || 0
      };
      
      activeRows.forEach(rowId => {
        const categorySelect = document.querySelector(`#${rowId} select`);
        const category = categorySelect ? categorySelect.value : null;
        const sizeSelect = document.getElementById(`${rowId}-size`);
        const size = sizeSelect ? sizeSelect.value : null;

        if (category && size && data && data[category] && data[category][size]) {
          const product = { category, size, unitPrice: data[category][size].price, flavors: [], productTotal: 0 };
          document.querySelectorAll(`#${rowId}-flavors-list .flavor-row`).forEach(row => {
            const flavor = row.querySelector('.flavor-select').value;
            const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
            if (flavor && quantity > 0) {
              product.flavors.push({ flavor, quantity, subtotal: quantity * product.unitPrice });
              product.productTotal += quantity * product.unitPrice;
            }
          });
          if (product.flavors.length > 0) orderData.products.push(product);
        }
      });
      
      try {
        showLoadingOverlay('Submitting order...');
        const response = await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) });
        hideLoadingOverlay();
        if (response.ok) {
          alert('Order submitted successfully!');
          document.getElementById('orderForm').reset(); document.getElementById('order-form').innerHTML = '';
          rowCount = 0; activeRows.clear(); flavorCount = {}; 
          selectedCustomerId = null; selectedCustomerAddress = '';
          document.getElementById('selectedCustomerAddress').style.display = 'none';
          document.getElementById('selectedCustomerAddress').textContent = '';
          document.getElementById('grandTotal').textContent = '0.00'; document.getElementById('grandQuantity').textContent = '0';
          showCustomerWarning(false); clearValidationErrors(); setDefaultOrderDate(); addProductRow();
        } else { throw new Error(`HTTP ${response.status}: ${response.statusText} while submitting order`); }
      } catch (error) { hideLoadingOverlay(); console.error('Error submitting order:', error); alert('Error submitting order. Please try again.'); }
    }

    document.addEventListener('DOMContentLoaded', async function() { // Made async
      const customerInput = document.getElementById('customerName');
      const dropdown = document.getElementById('customerDropdownList');
      const addressDisplayEl = document.getElementById('selectedCustomerAddress');

      setDefaultOrderDate(); 
      showLoadingOverlay('Initializing form data...'); // General message

      await initializeCustomerDropdown(); // Wait for customers
      await initializeProductData();      // Wait for products
      
      // Only add product row if product data was successfully loaded
      if (Object.keys(data).length > 0) {
          addProductRow();
      } else {
          console.error("Initial product row not added because product data failed to load.");
          // Optionally display a message to the user on the page
          const orderFormDiv = document.getElementById('order-form');
          if(orderFormDiv) {
            const errorMsg = document.createElement('p');
            errorMsg.textContent = "Product list could not be loaded. Please refresh or contact support.";
            errorMsg.style.color = "red";
            errorMsg.style.textAlign = "center";
            orderFormDiv.appendChild(errorMsg);
            document.querySelector('.btn[onclick="addProductRow()"]').disabled = true; // Disable add product button
          }
      }
      
      hideLoadingOverlay(); // Hide after all initial async operations

      // Customer input event listeners
      customerInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.trim(); 
        filterCustomers(searchTerm); 
        displayCustomerDropdown();
        if (searchTerm && !isValidCustomer(searchTerm)) {
            showCustomerWarning(true); 
        } else if (!searchTerm) {
            showCustomerWarning(false); 
            addressDisplayEl.style.display = 'none'; 
            addressDisplayEl.textContent = '';
        } else {
            showCustomerWarning(false); 
            const currentCustomer = getCustomerByName(searchTerm);
            if (currentCustomer) {
                displaySelectedCustomerAddress(currentCustomer.address);
            } else {
                 addressDisplayEl.style.display = 'none';
                 addressDisplayEl.textContent = '';
            }
        }
        clearValidationErrors();
      });

      customerInput.addEventListener('focus', function(e) { 
        if (e.target.value) { 
            filterCustomers(e.target.value.trim()); 
            displayCustomerDropdown(); 
        } 
      });
      customerInput.addEventListener('blur', hideCustomerDropdown);

      dropdown.addEventListener('mousedown', function(e) { e.preventDefault(); });
      dropdown.addEventListener('click', function(e) {
        if (e.target.classList.contains('dropdown-item')) {
          customerInput.value = e.target.dataset.value; 
          selectedCustomerId = e.target.dataset.id;
          selectedCustomerAddress = e.target.dataset.address; 
          displaySelectedCustomerAddress(selectedCustomerAddress);
          dropdown.style.display = 'none'; 
          showCustomerWarning(false); 
          clearValidationErrors();
        }
      });

      document.getElementById('orderDate').addEventListener('change', function() { validateOrderDate(); clearValidationErrors(); });
    });

    document.getElementById('customerName').addEventListener('keydown', function(e) {
      const dropdown = document.getElementById('customerDropdownList'); const items = dropdown.querySelectorAll('.dropdown-item');
      if (items.length === 0) return;
      let activeItem = dropdown.querySelector('.dropdown-item.active');
      let activeIndex = activeItem ? Array.from(items).indexOf(activeItem) : -1;
      switch(e.key) {
        case 'ArrowDown': 
          e.preventDefault(); 
          if (activeItem) activeItem.classList.remove('active'); 
          activeIndex = activeIndex < items.length - 1 ? activeIndex + 1 : 0; 
          items[activeIndex].classList.add('active'); 
          items[activeIndex].scrollIntoView({ block: 'nearest' }); 
          break;
        case 'ArrowUp': 
          e.preventDefault(); 
          if (activeItem) activeItem.classList.remove('active'); 
          activeIndex = activeIndex > 0 ? activeIndex - 1 : items.length - 1; 
          items[activeIndex].classList.add('active'); 
          items[activeIndex].scrollIntoView({ block: 'nearest' }); 
          break;
        case 'Enter': 
          e.preventDefault(); 
          if (activeItem) { 
            this.value = activeItem.dataset.value; 
            selectedCustomerId = activeItem.dataset.id; 
            selectedCustomerAddress = activeItem.dataset.address; 
            displaySelectedCustomerAddress(selectedCustomerAddress);
            dropdown.style.display = 'none'; 
            showCustomerWarning(false); 
            clearValidationErrors(); 
          } 
          break;
        case 'Escape': 
          dropdown.style.display = 'none'; 
          break;
      }
    });
    document.getElementById('customerDropdownList').addEventListener('mouseenter', function() { const activeItem = this.querySelector('.dropdown-item.active'); if (activeItem) activeItem.classList.remove('active'); });
    const style = document.createElement('style'); style.textContent = `.dropdown-item.active { background-color: #e3f2fd; color: #1976d2; }`; document.head.appendChild(style);
  </script>
</body>
</html>
