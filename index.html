<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product Order Form</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
      padding: 10px;
      max-width: 1200px;
      margin: auto;
      overflow-x: hidden;
    }
    
    h2 {
      text-align: center;
      color: #007BFF;
      margin-bottom: 30px;
      font-size: 1.5rem;
    }
    
    .form-row {
      background: #f9f9f9;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      padding: 15px;
    }
    
    .product-header {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 15px;
      align-items: end;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .form-group label {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
      text-transform: uppercase;
      color: #555;
    }
    
    .form-group select,
    .form-group input {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      min-width: 0;
      height: 40px;
    }
    
    .form-group input[readonly] {
      background: #eef5ff;
      color: #007BFF;
      font-weight: bold;
      text-align: center;
    }
    
    .flavors-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #e0e0e0;
    }
    
    .flavors-title {
      font-size: 14px;
      font-weight: bold;
      color: #007BFF;
      margin-bottom: 15px;
      text-transform: uppercase;
    }
    
    .flavor-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: #fff;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }
    
    .flavor-select {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      height: 36px;
    }
    
    .quantity-input {
      width: 80px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      height: 36px;
      text-align: center;
    }
    
    .remove-flavor-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      padding: 8px 12px;
      cursor: pointer;
      height: 36px;
      min-width: 60px;
    }
    
    .remove-flavor-btn:hover {
      background-color: #c82333;
    }
    
    .add-flavor-btn {
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      padding: 8px 15px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .add-flavor-btn:hover {
      background-color: #218838;
    }
    
    .add-flavor-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    .product-total {
      text-align: right;
      font-size: 16px;
      font-weight: bold;
      color: #007BFF;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
    }
    
    .delete-btn {
      background-color: #ffa500;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      padding: 8px;
      cursor: pointer;
      width: 100%;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .delete-btn:hover {
      background-color: #ff8c00;
    }
    
    .btn,
    .submit-btn {
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      width: 100%;
      max-width: 200px;
    }
    
    .btn {
      background-color: #007BFF;
      color: white;
      margin-bottom: 20px;
    }
    
    .btn:hover {
      background-color: #0056b3;
    }
    
    .submit-btn {
      background-color: #ffa500;
      color: white;
      width: 100%;
      max-width: none;
      margin-top: 20px;
    }
    
    .submit-btn:hover {
      background-color: #e69500;
    }
    
    .total-box {
      font-size: 18px;
      text-align: center;
      margin-top: 20px;
      background: #eef5ff;
      padding: 15px;
      border: 2px solid #007BFF;
      color: #007BFF;
      border-radius: 8px;
      word-break: break-word;
    }
    
    .customer-name {
      margin-bottom: 20px;
      position: relative;
      width: 100%;
    }
    
    /* Loading overlay */
    .loading-overlay {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007BFF;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #007BFF;
      font-size: 18px;
      font-weight: bold;
    }
    
    /* Monday.com search styles */
    .search-container {
      position: relative;
      width: 100%;
    }
    
    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #ddd;
      border-top: none;
      border-radius: 0 0 5px 5px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .dropdown-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      word-break: break-word;
    }
    
    .dropdown-item:hover,
    .dropdown-item.active {
      background-color: #f0f0f0;
    }
    
    .dropdown-item:last-child {
      border-bottom: none;
    }
    
    .no-results {
      padding: 10px 12px;
      color: #666;
      font-style: italic;
    }
    
    .customer-status {
      font-size: 12px;
      margin-top: 5px;
      color: #666;
    }
    
    .customer-warning {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-top: 5px;
      font-size: 14px;
      display: none;
      word-break: break-word;
    }
    
    /* Tablet styles */
    @media (max-width: 1024px) {
      body {
        padding: 8px;
      }
      
      .product-header {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      
      .delete-btn {
        grid-column: span 2;
        margin-top: 10px;
        max-width: 150px;
        justify-self: center;
      }
    }
    
    /* Mobile styles */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      
      h2 {
        font-size: 1.3rem;
        margin-bottom: 20px;
      }
      
      .form-row {
        padding: 12px;
      }
      
      .product-header {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .flavor-row {
        grid-template-columns: 1fr;
        gap: 10px;
        text-align: center;
      }
      
      .quantity-input {
        width: 100%;
        max-width: 120px;
        margin: 0 auto;
      }
      
      .remove-flavor-btn {
        width: 100%;
        max-width: 120px;
        margin: 0 auto;
      }
      
      .form-group label {
        font-size: 13px;
        margin-bottom: 6px;
      }
      
      .form-group select,
      .form-group input {
        padding: 12px 8px;
        font-size: 16px;
        min-height: 44px;
        height: 44px;
      }
      
      .delete-btn {
        padding: 12px;
        font-size: 16px;
        min-height: 44px;
        height: 44px;
        margin-top: 10px;
        max-width: none;
        width: 100%;
      }
      
      .btn {
        max-width: none;
        padding: 15px 20px;
        font-size: 18px;
      }
      
      .submit-btn {
        padding: 15px 20px;
        font-size: 18px;
        margin-top: 30px;
      }
      
      .total-box {
        font-size: 20px;
        padding: 20px 15px;
        margin-top: 30px;
      }
      
      .dropdown-list {
        max-height: 150px;
      }
      
      .dropdown-item {
        padding: 15px 12px;
        font-size: 16px;
      }
      
      .customer-warning {
        font-size: 15px;
        padding: 12px;
      }
    }
    
    /* Extra small screens */
    @media (max-width: 480px) {
      body {
        padding: 3px;
      }
      
      h2 {
        font-size: 1.2rem;
      }
      
      .form-row {
        padding: 10px 8px;
      }
      
      .total-box {
        font-size: 18px;
        padding: 15px 10px;
      }
      
      .flavor-row {
        padding: 8px;
      }
    }
    
    /* Very wide screens - prevent stretching */
    @media (min-width: 1200px) {
      .form-row {
        max-width: 1000px;
        margin-left: auto;
        margin-right: auto;
      }
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading customers...</div>
  </div>

  <h2>Product Order Form</h2>
  <form id="orderForm" onsubmit="submitOrder(event)">
    <div class="form-group customer-name">
      <label for="customerName">Customer Name</label>
      <div class="search-container">
        <input type="text" id="customerName" name="customerName" placeholder="Search for customer..." required autocomplete="off" />
        <div id="customerDropdownList" class="dropdown-list"></div>
      </div>
      <div id="customerStatus" class="customer-status">Loading customers...</div>
      <div id="customerWarning" class="customer-warning">
        ⚠️ Customer not found in the system. Select from Dropdown
      </div>
    </div>
    <div id="order-form"></div>
    <button class="btn" type="button" onclick="addProductRow()">+ Add Product</button>
    <div class="total-box">Grand Total: $<span id="grandTotal">0.00</span></div>
    <div id="validationErrors" class="validation-errors" style="display: none;"></div>
    <button class="submit-btn" type="submit">Submit Order</button>
  </form>

  <script>
    const WEBHOOK_URL = "https://hook.us2.make.com/675ao9xc3l8a0fwiqlb9iyq7xrh3r81j"; // Replace with your actual webhook URL
    
    // Monday.com Configuration
    const MONDAY_API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjUxOTIxNzk3MCwiYWFpIjoxMSwidWlkIjo3NjYxMTgyNiwiaWFkIjoiMjAyNS0wNS0yOVQwMTozNDoxOS4wMDBaIiwicGVyIjoibWU6d3JpdGUiLCJhY3RpZCI6Mjk0NjY1NjMsInJnbiI6InVzZTEifQ.YusQcMMhB4qL_QYTIhVVOzaaoN5i2ReecYQSDvNSoLU';
    const BOARD_ID = '9197029495';
    
    // Global variables for customer search
    let allCustomers = [];
    let filteredCustomers = [];
    let selectedCustomerId = null;
    
    const data = {
      "Ambient": {
        "10 oz. 24pk": { price: 19, flavors: ["OJ", "AP", "RR", "CRAN"] },
        "15.2 oz. 12pk": { price: 16, flavors: ["OJ", "AP", "RR", "CRAN", "GPE", "OP", "SK"] },
        "32 oz 12pk": { price: 31, flavors: ["OJ", "AP", "RR", "CRAN"] }
      },
      "Refreshers": {
        "11 oz. Refreshers & PP 12pk": { price: 19, flavors: ["OJ", "CAL", "HS", "TP", "AP", "CRAN", "GPE", "LEM", "RL", "PM", "FP"] },
        "46oz Refreshers 6pk": { price: 16, flavors: ["LEM", "FP", "W/M", "PM", "SP", "TP", "PP", "CP", "SL", "S/LIM"] },
        "46oz Essentials 6pk": { price: 18, flavors: ["OJ", "HS", "OM", "Spice"] }
      },
      "Pure Premium": {
        "14oz Pint PP 12pk": { price: 19, flavors: ["OJ", "HS", "CAL"] },
        "46oz PP 6pk": { price: 22, flavors: ["OJ", "HS", "GRV", "CAL", "RR", "OP", "LA", "light"] },
        "89 oz. PP": { price: 42, flavors: ["OJ", "HS", "CAL"] }
      },
      "Twisters": {
        "11oz Twister 12pk": { price: 19, flavors: ["FR", "OBS", "SK", "CB", "BL"] },
        "59oz Twister 8pk": { price: 14, flavors: ["TRP", "FP", "BB", "LEM", "OR", "PCH", "GRP"] }
      },
      "Naked": {
        "Naked 15.2oz 8pk": { price: 22, flavors: ["PC", "BLU", "GR", "MANG", "STR/BAN", "BB", "RB"] },
        "Naked 64 oz. 6pk": { price: 42, flavors: ["MM", "GM", "BM", "SB", "PC", "RB", "ORCAR"] }
      },
      "Kevita": {
        "Kevita 15.2oz 6pk": { price: 15, flavors: ["PP", "GIMG", "RABLE", "CH"] }
      }
    };

    let rowCount = 0;
    let activeRows = new Set();
    let flavorCount = {};

    // Validation functions
    function showValidationErrors(errors) {
      const errorDiv = document.getElementById('validationErrors');
      if (errors.length > 0) {
        errorDiv.innerHTML = `
          <div style="background-color: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 15px; margin: 15px 0; color: #c62828;">
            <strong>⚠️ Please fix the following issues before submitting:</strong>
            <ul style="margin: 10px 0 0 20px;">
              ${errors.map(error => `<li>${error}</li>`).join('')}
            </ul>
          </div>
        `;
        errorDiv.style.display = 'block';
        
        // Scroll to validation errors
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        return false;
      } else {
        errorDiv.style.display = 'none';
        return true;
      }
    }

    function validateForm() {
      const errors = [];
      
      // Validate customer name
      const customerName = document.getElementById('customerName').value.trim();
      if (!customerName) {
        errors.push('Customer name is required');
      } else if (!isValidCustomer(customerName)) {
        errors.push('Please select a valid customer from the dropdown list');
      }
      
      // Check if there are any product rows
      if (activeRows.size === 0) {
        errors.push('At least one product must be added');
        return showValidationErrors(errors);
      }
      
      let hasValidProducts = false;
      let productIndex = 1;
      
      // Validate each product row
      activeRows.forEach(rowId => {
        const category = document.querySelector(`#${rowId} select`)?.value;
        const size = document.getElementById(`${rowId}-size`)?.value;
        
        // Check if category is selected
        if (!category) {
          errors.push(`Product ${productIndex}: Category must be selected`);
        }
        
        // Check if size is selected
        if (!size) {
          errors.push(`Product ${productIndex}: Size must be selected`);
        }
        
        // If both category and size are selected, validate flavors
        if (category && size && data[category][size]) {
          const flavorRows = document.querySelectorAll(`#${rowId}-flavors-list .flavor-row`);
          let hasValidFlavors = false;
          let flavorIndex = 1;
          
          if (flavorRows.length === 0) {
            errors.push(`Product ${productIndex}: At least one flavor must be added`);
          } else {
            flavorRows.forEach(row => {
              const flavorSelect = row.querySelector('.flavor-select');
              const quantityInput = row.querySelector('.quantity-input');
              const flavor = flavorSelect.value;
              const quantity = parseInt(quantityInput.value) || 0;
              
              // Check if flavor is selected
              if (!flavor) {
                errors.push(`Product ${productIndex}, Flavor ${flavorIndex}: Flavor must be selected`);
              }
              
              // Check if quantity is valid
              if (quantity <= 0) {
                errors.push(`Product ${productIndex}, Flavor ${flavorIndex}: Quantity must be greater than 0`);
              }
              
              // If both flavor and quantity are valid, mark as having valid flavors
              if (flavor && quantity > 0) {
                hasValidFlavors = true;
                hasValidProducts = true;
              }
              
              flavorIndex++;
            });
            
            if (!hasValidFlavors) {
              errors.push(`Product ${productIndex}: At least one flavor with valid quantity is required`);
            }
          }
        }
        
        productIndex++;
      });
      
      // Check if there are any valid products
      if (!hasValidProducts && errors.length === 0) {
        errors.push('At least one complete product (with category, size, flavor, and quantity) is required');
      }
      
      // Check if grand total is greater than 0
      const grandTotal = parseFloat(document.getElementById('grandTotal').textContent);
      if (grandTotal <= 0) {
        errors.push('Order total must be greater than $0.00');
      }
      
      return showValidationErrors(errors);
    }

    function highlightIncompleteFields() {
      // Reset all field styles first
      document.querySelectorAll('input, select').forEach(field => {
        field.style.borderColor = '#ddd';
      });
      
      // Highlight incomplete customer field
      const customerName = document.getElementById('customerName').value.trim();
      if (!customerName || !isValidCustomer(customerName)) {
        document.getElementById('customerName').style.borderColor = '#f44336';
      }
      
      // Highlight incomplete product fields
      activeRows.forEach(rowId => {
        const categorySelect = document.querySelector(`#${rowId} select`);
        const sizeSelect = document.getElementById(`${rowId}-size`);
        
        if (!categorySelect.value) {
          categorySelect.style.borderColor = '#f44336';
        }
        
        if (!sizeSelect.value) {
          sizeSelect.style.borderColor = '#f44336';
        }
        
        // Highlight incomplete flavor fields
        const flavorRows = document.querySelectorAll(`#${rowId}-flavors-list .flavor-row`);
        flavorRows.forEach(row => {
          const flavorSelect = row.querySelector('.flavor-select');
          const quantityInput = row.querySelector('.quantity-input');
          
          if (!flavorSelect.value) {
            flavorSelect.style.borderColor = '#f44336';
          }
          
          if (!quantityInput.value || parseInt(quantityInput.value) <= 0) {
            quantityInput.style.borderColor = '#f44336';
          }
        });
      });
    }

    // Monday.com customer search functions
    function updateCustomerStatus(message, type = 'loading') {
      const statusEl = document.getElementById('customerStatus');
      statusEl.textContent = message;
      statusEl.style.color = type === 'error' ? '#c62828' : type === 'success' ? '#2e7d32' : '#666';
    }

    function showCustomerWarning(show = true) {
      const warningEl = document.getElementById('customerWarning');
      warningEl.style.display = show ? 'block' : 'none';
    }

    function isValidCustomer(customerName) {
      return allCustomers.some(customer => customer.name === customerName);
    }

    function getCustomerById(customerName) {
      return allCustomers.find(customer => customer.name === customerName);
    }

    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = 'none';
    }

    function showLoadingOverlay(text = 'Loading...') {
      const overlay = document.getElementById('loadingOverlay');
      const textEl = overlay.querySelector('.loading-text');
      textEl.textContent = text;
      overlay.style.display = 'flex';
    }

    async function fetchAllMondayCustomers() {
      updateCustomerStatus('Loading customers...', 'loading');
      
      try {
        if (!MONDAY_API_KEY || !BOARD_ID) {
          throw new Error('API Key or Board ID is missing');
        }

        let allItems = [];
        let cursor = null;
        let pageCount = 0;
        const itemsPerPage = 100;

        do {
          pageCount++;
          const query = `{
            boards(ids: ${BOARD_ID}) {
              id
              name
              items_page(limit: ${itemsPerPage}${cursor ? `, cursor: "${cursor}"` : ''}) {
                cursor
                items {
                  id
                  name
                }
              }
            }
          }`;

          const response = await fetch('https://api.monday.com/v2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': MONDAY_API_KEY
            },
            body: JSON.stringify({ query })
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.errors) {
            throw new Error(`GraphQL errors: ${JSON.stringify(data.errors)}`);
          }

          if (!data.data || !data.data.boards || data.data.boards.length === 0) {
            throw new Error('No boards found - check your Board ID and permissions');
          }

          const board = data.data.boards[0];
          const itemsPage = board.items_page;

          if (itemsPage && itemsPage.items) {
            allItems = allItems.concat(itemsPage.items);
            cursor = itemsPage.cursor;
            console.log(`Page ${pageCount}: Found ${itemsPage.items.length} customers, cursor: ${cursor}`);
          } else {
            break;
          }

          if (pageCount > 100) {
            console.warn('Reached maximum page limit (100), stopping pagination');
            break;
          }

        } while (cursor);

        console.log(`Total customers retrieved: ${allItems.length}`);
        return allItems;

      } catch (error) {
        console.error('Error fetching Monday.com customers:', error);
        updateCustomerStatus(`Error: ${error.message}`, 'error');
        return [];
      }
    }

    function filterCustomers(searchTerm) {
      if (!searchTerm) {
        filteredCustomers = [];
        return;
      }

      const term = searchTerm.toLowerCase();
      filteredCustomers = allCustomers.filter(customer => 
        customer.name.toLowerCase().includes(term)
      ).slice(0, 50);
    }

    function displayCustomerDropdown() {
      const dropdown = document.getElementById('customerDropdownList');
      const input = document.getElementById('customerName');

      if (filteredCustomers.length === 0 && input.value) {
        dropdown.innerHTML = '<div class="no-results">No customers found</div>';
        dropdown.style.display = 'block';
        return;
      }

      if (filteredCustomers.length === 0) {
        dropdown.style.display = 'none';
        return;
      }

      dropdown.innerHTML = filteredCustomers.map(customer => 
        `<div class="dropdown-item" data-value="${customer.name}" data-id="${customer.id}">${customer.name}</div>`
      ).join('');

      dropdown.style.display = 'block';
    }

    function hideCustomerDropdown() {
      setTimeout(() => {
        document.getElementById('customerDropdownList').style.display = 'none';
      }, 150);
    }

    async function initializeCustomerDropdown() {
      try {
        allCustomers = await fetchAllMondayCustomers();

        if (allCustomers.length === 0) {
          updateCustomerStatus('No customers found', 'error');
          hideLoadingOverlay();
          return;
        }

        updateCustomerStatus(`${allCustomers.length} customers loaded`, 'success');
        console.log(`Initialized with ${allCustomers.length} customers`);
        
        // Hide loading overlay after customers are loaded
        hideLoadingOverlay();

      } catch (error) {
        console.error('Error initializing customer dropdown:', error);
        updateCustomerStatus(`Error: ${error.message}`, 'error');
        hideLoadingOverlay();
      }
    }

    // Product form functions
    function addProductRow() {
      rowCount++;
      const rowId = `row-${rowCount}`;
      activeRows.add(rowId);
      flavorCount[rowId] = 1;
      
      const row = document.createElement('div');
      row.className = 'form-row';
      row.id = rowId;
      row.innerHTML = `
        <div class="product-header">
          <div class="form-group">
            <label>Category</label>
            <select onchange="populateSizes('${rowId}', this.value); clearValidationErrors();">
              <option value="">Select Category</option>
              ${Object.keys(data).map(cat => `<option value="${cat}">${cat}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label>Size</label>
            <select id="${rowId}-size" onchange="populateFlavors('${rowId}', this.value); clearValidationErrors();">
              <option value="">Select Size</option>
            </select>
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button class="delete-btn" type="button" onclick="deleteRow('${rowId}')">×</button>
          </div>
        </div>
        <div class="flavors-section" id="${rowId}-flavors-section" style="display: none;">
          <div class="flavors-title">Select Flavors and Quantities</div>
          <div id="${rowId}-flavors-list"></div>
          <button type="button" class="add-flavor-btn" id="${rowId}-add-flavor" onclick="addFlavorRow('${rowId}')" disabled>+ Add More</button>
        </div>
        <div class="product-total" id="${rowId}-total">Product Total: $0.00</div>
      `;
      document.getElementById('order-form').appendChild(row);
      updateDeleteButtons();
      updateTotal();
    }

    function clearValidationErrors() {
      const errorDiv = document.getElementById('validationErrors');
      errorDiv.style.display = 'none';
      
      // Reset field border colors
      document.querySelectorAll('input, select').forEach(field => {
        if (field.style.borderColor === 'rgb(244, 67, 54)') {
          field.style.borderColor = '#ddd';
        }
      });
    }

    function populateSizes(rowId, category) {
      const sizeField = document.getElementById(`${rowId}-size`);
      const flavorsSection = document.getElementById(`${rowId}-flavors-section`);
      
      sizeField.innerHTML = '<option value="">Select Size</option>';
      flavorsSection.style.display = 'none';
      
      if (category && data[category]) {
        Object.keys(data[category]).forEach(size => {
          sizeField.innerHTML += `<option value="${size}">${size}</option>`;
        });
      }
      updateTotal();
    }

    function populateFlavors(rowId, size) {
      const category = document.querySelector(`#${rowId} select`).value;
      const flavorsSection = document.getElementById(`${rowId}-flavors-section`);
      const flavorsList = document.getElementById(`${rowId}-flavors-list`);
      const addButton = document.getElementById(`${rowId}-add-flavor`);
      
      if (category && size && data[category][size]) {
        flavorsSection.style.display = 'block';
        flavorsList.innerHTML = '';
        flavorCount[rowId] = 1;
        
        // Add first flavor row
        addFlavorRowInternal(rowId);
        addButton.disabled = false;
      } else {
        flavorsSection.style.display = 'none';
        addButton.disabled = true;
      }
      updateTotal();
    }

    function addFlavorRow(rowId) {
      flavorCount[rowId]++;
      addFlavorRowInternal(rowId);
    }

    function addFlavorRowInternal(rowId) {
      const category = document.querySelector(`#${rowId} select`).value;
      const size = document.getElementById(`${rowId}-size`).value;
      const flavorsList = document.getElementById(`${rowId}-flavors-list`);
      const flavorId = `${rowId}-flavor-${flavorCount[rowId]}`;
      
      if (!category || !size || !data[category][size]) return;
      
      const availableFlavors = data[category][size].flavors;
      const flavorRow = document.createElement('div');
      flavorRow.className = 'flavor-row';
      flavorRow.id = flavorId;
      flavorRow.innerHTML = `
        <select class="flavor-select" onchange="updateTotal(); clearValidationErrors();">
          <option value="">Select Flavor</option>
          ${availableFlavors.map(flavor => `<option value="${flavor}">${flavor}</option>`).join('')}
        </select>
        <input type="number" class="quantity-input" min="1" value="1" onchange="updateTotal(); clearValidationErrors();" placeholder="Qty" />
        <button type="button" class="remove-flavor-btn" onclick="removeFlavorRow('${flavorId}', '${rowId}')">Remove</button>
      `;
      
      flavorsList.appendChild(flavorRow);
      updateRemoveFlavorButtons(rowId);
    }

    function removeFlavorRow(flavorId, rowId) {
      const flavorRow = document.getElementById(flavorId);
      if (flavorRow) {
        flavorRow.remove();
        updateRemoveFlavorButtons(rowId);
        updateTotal();
      }
    }

    function updateRemoveFlavorButtons(rowId) {
      const flavorRows = document.querySelectorAll(`#${rowId}-flavors-list .flavor-row`);
      flavorRows.forEach(row => {
        const removeBtn = row.querySelector('.remove-flavor-btn');
        removeBtn.style.display = flavorRows.length > 1 ? 'block' : 'none';
      });
    }

    function updateDeleteButtons() {
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.style.display = activeRows.size > 1 ? 'flex' : 'none';
      });
    }

    function deleteRow(rowId) {
      if (activeRows.size > 1) {
        document.getElementById(rowId).remove();
        activeRows.delete(rowId);
        delete flavorCount[rowId];
        updateDeleteButtons();
        updateTotal();
        clearValidationErrors();
      }
    }

    function updateTotal() {
      let grandTotal = 0;
      
      activeRows.forEach(rowId => {
        const category = document.querySelector(`#${rowId} select`)?.value;
        const size = document.getElementById(`${rowId}-size`)?.value;
        let productTotal = 0;
        
        if (category && size && data[category][size]) {
          const unitPrice = data[category][size].price;
          const flavorRows = document.querySelectorAll(`#${rowId}-flavors-list .flavor-row`);
          
          flavorRows.forEach(row => {
            const flavorSelect = row.querySelector('.flavor-select');
            const quantityInput = row.querySelector('.quantity-input');
            const flavor = flavorSelect.value;
            const quantity = parseInt(quantityInput.value) || 0;
            
            if (flavor && quantity > 0) {
              productTotal += quantity * unitPrice;
            }
          });
        }
        
        const productTotalEl = document.getElementById(`${rowId}-total`);
        if (productTotalEl) {
          productTotalEl.textContent = `Product Total: $${productTotal.toFixed(2)}`;
        }
        
        grandTotal += productTotal;
      });
      
      document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
    }

    async function submitOrder(event) {
      event.preventDefault();
      
      // Clear any previous validation errors
      clearValidationErrors();
      
      // Validate the form before submission
      if (!validateForm()) {
        highlightIncompleteFields();
        return;
      }
      
      const customerName = document.getElementById('customerName').value.trim();
      const customer = getCustomerById(customerName);
      const orderData = {
        customer: {
          name: customerName,
          id: customer ? customer.id : null
        },
        products: [],
        grandTotal: parseFloat(document.getElementById('grandTotal').textContent)
      };
      
      activeRows.forEach(rowId => {
        const category = document.querySelector(`#${rowId} select`)?.value;
        const size = document.getElementById(`${rowId}-size`)?.value;
        
        if (category && size && data[category][size]) {
          const product = {
            category,
            size,
            unitPrice: data[category][size].price,
            flavors: [],
            productTotal: 0
          };
          
          const flavorRows = document.querySelectorAll(`#${rowId}-flavors-list .flavor-row`);
          
          flavorRows.forEach(row => {
            const flavorSelect = row.querySelector('.flavor-select');
            const quantityInput = row.querySelector('.quantity-input');
            const flavor = flavorSelect.value;
            const quantity = parseInt(quantityInput.value) || 0;
            
            if (flavor && quantity > 0) {
              product.flavors.push({
                flavor,
                quantity,
                subtotal: quantity * product.unitPrice
              });
              product.productTotal += quantity * product.unitPrice;
            }
          });
          
          if (product.flavors.length > 0) {
            orderData.products.push(product);
          }
        }
      });
      
      try {
        showLoadingOverlay('Submitting order...');
        
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(orderData)
        });
        
        hideLoadingOverlay();
        
        if (response.ok) {
          alert('Order submitted successfully!');
          // Reset form
          document.getElementById('orderForm').reset();
          document.getElementById('order-form').innerHTML = '';
          rowCount = 0;
          activeRows.clear();
          flavorCount = {};
          selectedCustomerId = null;
          document.getElementById('grandTotal').textContent = '0.00';
          showCustomerWarning(false);
          clearValidationErrors();
          // Add initial product row
          addProductRow();
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        hideLoadingOverlay();
        console.error('Error submitting order:', error);
        alert('Error submitting order. Please try again.');
      }
    }

    // Event listeners for customer search
    document.addEventListener('DOMContentLoaded', function() {
      const customerInput = document.getElementById('customerName');
      const dropdown = document.getElementById('customerDropdownList');
      
      customerInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.trim();
        filterCustomers(searchTerm);
        displayCustomerDropdown();
        
        if (searchTerm && !isValidCustomer(searchTerm)) {
          showCustomerWarning(true);
        } else {
          showCustomerWarning(false);
        }
        
        clearValidationErrors();
      });
      
      customerInput.addEventListener('focus', function(e) {
        if (e.target.value) {
          filterCustomers(e.target.value.trim());
          displayCustomerDropdown();
        }
      });
      
      customerInput.addEventListener('blur', function() {
        hideCustomerDropdown();
      });
      
      dropdown.addEventListener('mousedown', function(e) {
        e.preventDefault(); // Prevent blur event
      });
      
      dropdown.addEventListener('click', function(e) {
        if (e.target.classList.contains('dropdown-item')) {
          const customerName = e.target.dataset.value;
          const customerId = e.target.dataset.id;
          
          customerInput.value = customerName;
          selectedCustomerId = customerId;
          dropdown.style.display = 'none';
          showCustomerWarning(false);
          clearValidationErrors();
        }
      });
      
      // Initialize customer dropdown and add first product row
      initializeCustomerDropdown();
      addProductRow();
    });

    // Handle keyboard navigation for dropdown
    document.getElementById('customerName').addEventListener('keydown', function(e) {
      const dropdown = document.getElementById('customerDropdownList');
      const items = dropdown.querySelectorAll('.dropdown-item');
      
      if (items.length === 0) return;
      
      let activeItem = dropdown.querySelector('.dropdown-item.active');
      let activeIndex = activeItem ? Array.from(items).indexOf(activeItem) : -1;
      
      switch(e.key) {
        case 'ArrowDown':
          e.preventDefault();
          if (activeItem) activeItem.classList.remove('active');
          activeIndex = activeIndex < items.length - 1 ? activeIndex + 1 : 0;
          items[activeIndex].classList.add('active');
          items[activeIndex].scrollIntoView({ block: 'nearest' });
          break;
          
        case 'ArrowUp':
          e.preventDefault();
          if (activeItem) activeItem.classList.remove('active');
          activeIndex = activeIndex > 0 ? activeIndex - 1 : items.length - 1;
          items[activeIndex].classList.add('active');
          items[activeIndex].scrollIntoView({ block: 'nearest' });
          break;
          
        case 'Enter':
          if (activeItem) {
            e.preventDefault();
            const customerName = activeItem.dataset.value;
            const customerId = activeItem.dataset.id;
            
            this.value = customerName;
            selectedCustomerId = customerId;
            dropdown.style.display = 'none';
            showCustomerWarning(false);
            clearValidationErrors();
          }
          break;
          
        case 'Escape':
          dropdown.style.display = 'none';
          break;
      }
    });
  </script>
</body>
</html>
